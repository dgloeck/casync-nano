#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <stdint.h>
#include <string.h>

#include <cmocka.h>

#include "utils.h"
#include "chunker.h"
#include "xorshift32.h"

static int create_chunker(void **state)
{
	*state = test_malloc(sizeof(struct chunker));

	struct chunker *c = (struct chunker*)*state;

	struct chunker_params params = {
		.min_size = CHUNKER_SIZE_AVG_DEFAULT / 4,
		.avg_size = CHUNKER_SIZE_AVG_DEFAULT,
		.max_size = CHUNKER_SIZE_AVG_DEFAULT * 4,
	};

	chunker_init(c, &params);

	return 0;
}

static int destroy_chunker(void **state)
{
	test_free(*state);
	return 0;
}

#define RANDOM_SEED 0xAFFED00F
#define RANDOM_SIZE (100ull * 1024 * 1024)
static const size_t random_chunk_boundaries[] = {
	243768, 265304, 309942, 409375, 486572, 525729, 575730, 615354, 658735, 707616,
	745028, 807648, 857443, 955152, 974702, 1071516, 1184150, 1290448, 1401104, 1455201,
	1665844, 1705922, 1767765, 1822814, 1880834, 1900815, 1922155, 2095042, 2155294,
	2226503, 2246791, 2348781, 2390659, 2409422, 2429771, 2449277, 2494712, 2555741,
	2584908, 2704206, 2746401, 2977696, 3019812, 3046126, 3098768, 3251838, 3279507,
	3444595, 3470370, 3607304, 3644965, 3814531, 3883513, 3982410, 4023592, 4054169,
	4085987, 4113606, 4161195, 4259960, 4300217, 4399028, 4431796, 4523952, 4674653,
	4716637, 4759628, 4856482, 4927556, 5082318, 5225836, 5331006, 5375730, 5401630,
	5439736, 5599662, 5645047, 5685765, 5739270, 5833978, 5899732, 6020501, 6099506,
	6118819, 6239946, 6266464, 6305618, 6369443, 6393199, 6465630, 6521644, 6598242,
	6619420, 6696468, 6716821, 6736233, 6825801, 6849690, 6894552, 6974605, 6991691,
	7045137, 7116482, 7153120, 7235076, 7267491, 7368424, 7406173, 7443627, 7492706,
	7621063, 7638968, 7792691, 7873114, 7896945, 7951860, 8044247, 8096475, 8183954,
	8221961, 8311131, 8382668, 8475430, 8520060, 8566341, 8592529, 8621358, 8694402,
	8857333, 8897308, 8944492, 8967926, 9072418, 9141548, 9217692, 9327557, 9364954,
	9417768, 9519814, 9569310, 9607327, 9849112, 9869469, 9931277, 9998368, 10121062,
	10255285, 10303758, 10362165, 10409836, 10440730, 10466709, 10499032, 10526969,
	10555272, 10627323, 10713888, 10736652, 10774032, 10855338, 10888397, 11150541,
	11242616, 11446226, 11581253, 11644237, 11699361, 11764855, 11817548, 11945705,
	11971076, 12004845, 12062326, 12093020, 12166696, 12198804, 12336949, 12384838,
	12498123, 12536640, 12572614, 12682177, 12737709, 12766166, 12816298, 12853496,
	13068918, 13161792, 13221396, 13249143, 13372783, 13416217, 13456461, 13511241,
	13563172, 13585286, 13629176, 13668571, 13724459, 13783672, 13877082, 13923609,
	13955979, 14019485, 14074221, 14134242, 14396386, 14453307, 14529905, 14574010,
	14599164, 14647273, 14740570, 14844179, 14905350, 14930987, 15040612, 15071209,
	15149667, 15197274, 15255264, 15339865, 15357450, 15382048, 15448371, 15469299,
	15596273, 15629434, 15649984, 15739632, 15795833, 15921200, 15953032, 15976164,
	16151885, 16203306, 16307391, 16381675, 16457806, 16524860, 16576350, 16647125,
	16758274, 16889736, 16985058, 17070626, 17143871, 17163573, 17222498, 17306765,
	17409286, 17427501, 17497000, 17517257, 17592298, 17669328, 17715288, 17775523,
	17862737, 17934524, 18027022, 18052388, 18069639, 18086553, 18111260, 18172046,
	18379690, 18413756, 18555453, 18589359, 18636214, 18774356, 18845687, 18893834,
	18917458, 18969184, 18999255, 19038030, 19093245, 19144426, 19193088, 19238654,
	19255345, 19294746, 19394058, 19432047, 19585657, 19613158, 19651734, 19751521,
	19772203, 19963203, 19981852, 20069286, 20104136, 20146228, 20262172, 20333558,
	20387114, 20414446, 20546533, 20573193, 20647245, 20733229, 20771238, 20826356,
	20859702, 20877916, 20907144, 20969843, 20992394, 21024470, 21208153, 21267688,
	21308992, 21374920, 21490836, 21515948, 21591484, 21745465, 21878127, 22070496,
	22236221, 22303383, 22339484, 22468278, 22515707, 22559964, 22581082, 22718709,
	22888531, 22996783, 23087481, 23131527, 23222630, 23257383, 23278203, 23374366,
	23395197, 23425987, 23474287, 23571919, 23694401, 23848884, 23932389, 24027110,
	24209458, 24290225, 24323912, 24368313, 24423619, 24593826, 24645867, 24908011,
	24925971, 24961003, 25043152, 25104116, 25204626, 25307135, 25341499, 25404935,
	25450687, 25471353, 25571747, 25617181, 25734464, 25756065, 25849378, 25908511,
	25949386, 26091001, 26353145, 26381441, 26428817, 26501675, 26571182, 26654007,
	26704713, 26744618, 26778898, 26801453, 26873277, 26932974, 26969780, 27030424,
	27063624, 27126899, 27293370, 27319024, 27376052, 27442473, 27477806, 27552991,
	27575240, 27607480, 27703332, 27736458, 27757743, 27889149, 27955043, 28100090,
	28160649, 28205428, 28318694, 28345786, 28443731, 28614131, 28836070, 28973255,
	28995654, 29067144, 29209776, 29351528, 29472986, 29521373, 29556158, 29595752,
	29741977, 29763573, 29818574, 29855482, 29887933, 29923891, 30013763, 30063166,
	30192308, 30229199, 30246414, 30289529, 30319618, 30342361, 30420496, 30481742,
	30539649, 30585582, 30625666, 30677795, 30713298, 30794811, 30853217, 30961366,
	30998971, 31056939, 31114573, 31193007, 31226206, 31244178, 31296797, 31322492,
	31381249, 31429824, 31488811, 31515414, 31564159, 31655237, 31699055, 31828648,
	31910341, 31975355, 32063870, 32129676, 32170387, 32191984, 32211867, 32468631,
	32517099, 32539731, 32627014, 32659671, 32830078, 32866503, 32962267, 32984299,
	33090266, 33125390, 33166894, 33187236, 33219489, 33302357, 33336742, 33429169,
	33448251, 33577905, 33618850, 33787342, 33903799, 33923987, 34011139, 34056597,
	34108327, 34204653, 34234971, 34268018, 34375784, 34488868, 34514917, 34532027,
	34549572, 34649350, 34684814, 34768968, 34809571, 34869115, 34996067, 35110119,
	35130721, 35147717, 35218656, 35243013, 35260324, 35280691, 35418008, 35438043,
	35470559, 35542580, 35677826, 35698815, 35741664, 35819490, 35838061, 35898709,
	35927080, 35949745, 36004707, 36089140, 36215353, 36347748, 36449273, 36468993,
	36492809, 36514695, 36564475, 36608980, 36661494, 36679437, 36718410, 36753978,
	36808871, 36852823, 36871874, 36915370, 36932439, 36995049, 37018166, 37078819,
	37097223, 37117968, 37211443, 37284534, 37487648, 37610572, 37634876, 37685746,
	37742972, 37762524, 37798348, 37832517, 37857395, 37892740, 38081819, 38152312,
	38185356, 38354507, 38413806, 38445314, 38491454, 38621908, 38808299, 38857717,
	38965742, 39017716, 39036242, 39101774, 39183648, 39218299, 39264409, 39449261,
	39533363, 39571078, 39591177, 39612448, 39676727, 39783773, 39868971, 39910199,
	39950993, 40048366, 40070068, 40199841, 40223146, 40242974, 40308980, 40365138,
	40407025, 40485112, 40515256, 40550427, 40572145, 40610742, 40675732, 40781928,
	40890587, 40908309, 40931951, 40980879, 41139911, 41164705, 41295177, 41400590,
	41437807, 41565401, 41664049, 41703705, 41829906, 41874983, 41934789, 42026620,
	42091389, 42109727, 42167188, 42189983, 42225997, 42396542, 42507696, 42537605,
	42561089, 42770618, 42812840, 42880605, 42933039, 42968918, 42992344, 43136802,
	43177275, 43217000, 43322048, 43346772, 43453905, 43471553, 43528683, 43556385,
	43613172, 43632438, 43688423, 43717690, 43780853, 43815396, 43863389, 43913444,
	43949370, 43967961, 44099703, 44323096, 44416790, 44487042, 44504415, 44694666,
	44910908, 45123988, 45179785, 45336256, 45360139, 45386173, 45434444, 45543334,
	45566384, 45622715, 45694535, 45735849, 45790789, 45811309, 45878581, 45926014,
	46047467, 46195852, 46286950, 46331527, 46378283, 46397343, 46423775, 46559707,
	46609522, 46633193, 46700646, 46726551, 46807508, 46854999, 46959920, 46977074,
	47010335, 47058459, 47138972, 47225249, 47258529, 47348441, 47385348, 47419197,
	47475678, 47529096, 47698504, 47802880, 47873780, 48005712, 48034733, 48111179,
	48180636, 48206706, 48268354, 48433800, 48552938, 48579567, 48705251, 48743635,
	48762767, 48825122, 49021838, 49066145, 49086392, 49108768, 49226991, 49271400,
	49305893, 49356173, 49374895, 49401675, 49418815, 49543190, 49560723, 49577763,
	49615104, 49694969, 49795966, 49837389, 49885841, 50006136, 50033296, 50068935,
	50108306, 50330510, 50400973, 50450687, 50483527, 50553024, 50633401, 50662978,
	50763965, 50785963, 50844364, 50949402, 50978961, 51007043, 51052741, 51072276,
	51113337, 51293469, 51314824, 51392638, 51410827, 51448023, 51471158, 51583028,
	51627402, 51674496, 51789353, 51874050, 51926864, 51993607, 52032676, 52076919,
	52135269, 52195006, 52236178, 52364215, 52383437, 52465338, 52571327, 52598638,
	52690610, 52719467, 52878873, 52896331, 52928924, 52972869, 53019465, 53112335,
	53138152, 53190841, 53271347, 53339884, 53357892, 53391083, 53410456, 53442844,
	53461698, 53516682, 53544701, 53611529, 53745871, 54008015, 54072868, 54110210,
	54169610, 54188107, 54243814, 54283095, 54342688, 54427241, 54452663, 54474270,
	54493776, 54523004, 54719363, 54758981, 54858018, 54880585, 54932573, 55015415,
	55213253, 55232405, 55353761, 55374422, 55420003, 55567139, 55683107, 55755959,
	56018103, 56097389, 56173554, 56351881, 56372871, 56520005, 56557817, 56629959,
	56718331, 56805604, 56838544, 56913613, 57071115, 57163387, 57235490, 57368511,
	57397080, 57441010, 57481989, 57507934, 57535941, 57581293, 57609109, 57720657,
	57737646, 57754757, 57781580, 57807801, 57849811, 57941029, 58002452, 58029803,
	58075207, 58200637, 58262406, 58311676, 58410704, 58478120, 58536247, 58642535,
	58676287, 58710845, 58739577, 58854985, 59015604, 59084440, 59183226, 59265159,
	59283757, 59307628, 59336561, 59380325, 59490491, 59512104, 59545531, 59609618,
	59627799, 59676091, 59705675, 59789816, 59875586, 59917614, 59936304, 59964495,
	60033884, 60151825, 60186018, 60218864, 60350030, 60431713, 60450859, 60489915,
	60550004, 60584576, 60650106, 60745805, 60906245, 60941007, 60976258, 60997320,
	61018493, 61047996, 61072887, 61114397, 61192706, 61371238, 61388604, 61461503,
	61477974, 61516424, 61546010, 61630792, 61704942, 61765683, 61797702, 61816994,
	61861467, 61915660, 61960822, 62104108, 62136805, 62175022, 62191417, 62230020,
	62267428, 62310480, 62429066, 62493067, 62630136, 62656327, 62831308, 62909051,
	62961155, 62988445, 63035023, 63100708, 63123263, 63197122, 63229073, 63279182,
	63296712, 63345000, 63439112, 63506072, 63563336, 63699363, 63728798, 63769047,
	63793597, 63864866, 63934040, 63974093, 64036919, 64088774, 64185766, 64216023,
	64248960, 64305124, 64377605, 64410434, 64436103, 64469686, 64632190, 64894334,
	65030655, 65065613, 65112034, 65336229, 65385971, 65483419, 65501773, 65525788,
	65543663, 65664918, 65710537, 65824893, 65966312, 65996355, 66045068, 66173237,
	66214649, 66239467, 66304885, 66348533, 66515500, 66549701, 66636005, 66748888,
	66766198, 66826491, 66901593, 66968368, 67118298, 67144889, 67216352, 67314735,
	67423279, 67464425, 67554353, 67661233, 67684065, 67789810, 67851470, 67871056,
	67947347, 67991400, 68040154, 68093103, 68184189, 68220695, 68316937, 68360313,
	68473350, 68496425, 68540442, 68560932, 68626862, 68644078, 68792398, 68827170,
	68888890, 68918206, 68975600, 69127681, 69169631, 69213767, 69251924, 69268881,
	69294872, 69333681, 69595825, 69662218, 69780215, 69809905, 69832630, 69858061,
	70018173, 70050268, 70226675, 70257826, 70279637, 70311029, 70546289, 70699789,
	70793355, 70812249, 70867141, 70929853, 70949019, 71111031, 71190131, 71218664,
	71262061, 71326665, 71359776, 71382846, 71412891, 71467179, 71501472, 71665289,
	71732508, 71774006, 71814720, 71917360, 71998823, 72057933, 72077982, 72120518,
	72141118, 72189998, 72208834, 72241047, 72320619, 72379380, 72480075, 72516680,
	72542935, 72637020, 72705824, 72753730, 72777218, 73039362, 73169216, 73306433,
	73354611, 73401730, 73420340, 73465113, 73495920, 73557651, 73693897, 73735519,
	73798352, 73839315, 73903177, 73986080, 74075482, 74106713, 74213050, 74231675,
	74289595, 74341930, 74391522, 74420264, 74457822, 74494342, 74554155, 74696332,
	74724172, 74770346, 74812163, 74846180, 74872831, 74937792, 74986869, 75130796,
	75158399, 75209312, 75298641, 75379382, 75497080, 75550494, 75587266, 75671584,
	75710215, 75785736, 75929527, 75974898, 76058956, 76321100, 76394554, 76418271,
	76537864, 76604848, 76651032, 76709968, 76794244, 77051786, 77154916, 77185223,
	77302562, 77363139, 77525132, 77587367, 77661105, 77691089, 77713844, 77778031,
	77839782, 77959914, 77984147, 78019215, 78058962, 78103129, 78173006, 78223638,
	78263804, 78333884, 78391246, 78519583, 78550312, 78589911, 78634821, 78727597,
	78818915, 78838052, 78898246, 78920767, 78939958, 79157167, 79183071, 79374385,
	79423807, 79448753, 79534923, 79565229, 79667259, 79759868, 79943755, 79966440,
	79988089, 80022736, 80049451, 80079494, 80096052, 80140066, 80174767, 80200707,
	80282851, 80394785, 80462283, 80494896, 80521918, 80544504, 80590689, 80671735,
	80933879, 81082359, 81206527, 81232473, 81280888, 81339924, 81505297, 81577229,
	81596851, 81650173, 81667410, 81698846, 81721839, 81777782, 81830567, 81897032,
	81940474, 82025390, 82131203, 82151975, 82235241, 82268069, 82413074, 82464704,
	82600117, 82699326, 82720927, 82773118, 82830330, 82961205, 83043818, 83305962,
	83327924, 83462443, 83504264, 83565947, 83603373, 83644237, 83673351, 83710268,
	83798183, 83877121, 83941969, 83967914, 83994044, 84012958, 84046204, 84067471,
	84098614, 84116502, 84133968, 84396112, 84551984, 84568387, 84590227, 84670572,
	84721238, 84791562, 84933338, 84961876, 84995961, 85012577, 85063106, 85136609,
	85154804, 85183544, 85302831, 85350697, 85384895, 85424312, 85461953, 85541199,
	85610213, 85629088, 85676115, 85780789, 85938122, 86046405, 86091417, 86134899,
	86171172, 86190893, 86224095, 86351465, 86476878, 86532067, 86584408, 86639993,
	86675652, 86778143, 86800312, 86834512, 86851814, 86924590, 86977726, 87008229,
	87148414, 87172154, 87204696, 87347804, 87563189, 87677946, 87702489, 87726967,
	87848148, 87895316, 87969615, 88000317, 88066914, 88314340, 88346651, 88480272,
	88540740, 88604355, 88866499, 88988073, 89004486, 89023410, 89057642, 89150028,
	89174564, 89206731, 89232093, 89272556, 89316380, 89338882, 89359288, 89508252,
	89539902, 89595604, 89677851, 89722676, 89818027, 90038675, 90061555, 90130374,
	90189874, 90237195, 90293140, 90310944, 90357535, 90453624, 90533506, 90557971,
	90579335, 90608392, 90661366, 90715319, 90741214, 90772937, 90863809, 90903970,
	90992650, 91043911, 91144060, 91161233, 91266191, 91286808, 91443239, 91478899,
	91504712, 91562022, 91615262, 91664702, 91703729, 91758544, 91854625, 91960427,
	91988977, 92021523, 92092413, 92225544, 92285585, 92339976, 92358249, 92405885,
	92476885, 92532594, 92572380, 92589278, 92638828, 92668130, 92765436, 92784615,
	92812917, 92876803, 92899306, 93108223, 93172389, 93290988, 93379684, 93421940,
	93439674, 93517407, 93538223, 93589846, 93739198, 93829164, 93915919, 94059124,
	94078766, 94143431, 94267612, 94329802, 94412782, 94502384, 94534660, 94624372,
	94648822, 94675613, 94700980, 94756065, 94792892, 94881587, 94968956, 94988908,
	95037583, 95085274, 95184444, 95224724, 95252103, 95307003, 95393612, 95430038,
	95480614, 95512017, 95581473, 95617515, 95734758, 95843676, 95861657, 95909106,
	96023266, 96165582, 96361994, 96392485, 96416205, 96483954, 96503140, 96522059,
	96562279, 96579217, 96607553, 96814063, 96885373, 96965146, 97043022, 97101196,
	97155521, 97186129, 97249636, 97285970, 97313768, 97412608, 97432881, 97656423,
	97839676, 97876197, 97974491, 98236635, 98267546, 98345548, 98366257, 98485018,
	98513197, 98531886, 98672120, 98716799, 98849044, 98875698, 98920192, 98960464,
	99058776, 99203324, 99225122, 99278342, 99340912, 99392712, 99474951, 99550054,
	99618707, 99667688, 99722262, 99807398, 99904654, 99968201, 100034455, 100075897,
	100096216, 100203280, 100261342, 100434041, 100478276, 100565262, 100620551,
	100715606, 100735365, 100893047, 100921632, 100953547, 100979933, 101066306,
	101135513, 101207970, 101227748, 101393798, 101428271, 101584341, 101625105,
	101727433, 101753597, 101781789, 101839805, 101901027, 102084417, 102106963,
	102205320, 102226555, 102315711, 102392229, 102459090, 102533845, 102565931,
	102594126, 102654465, 102682127, 102751117, 102790827, 102834545, 102942563,
	103018495, 103051028, 103102577, 103148551, 103187170, 103220498, 103250280,
	103358188, 103455347, 103679477, 103696462, 103825978, 103843772, 103894750,
	103977485, 104011964, 104043373, 104195503, 104235611, 104323736, 104378093,
	104476988, 104494831, 104519439, 104546306, 104620983, 104714776, 104735252
};

static const uint8_t random_chunk_ids[] = {
	0xda, 0x39, 0x94, 0xf1, 0x3b, 0x17, 0xbc, 0xea, 0x35, 0x43, 0x52, 0x05, 0x50, 0x5f, 0x59, 0xf4,
	0x10, 0x2e, 0xa9, 0xe5, 0x5f, 0x9c, 0x82, 0x83, 0x13, 0xd3, 0xd9, 0xb5, 0xcc, 0xc9, 0xf9, 0x55,

	0x34, 0xae, 0x40, 0xbf, 0x5b, 0xbe, 0xe5, 0x88, 0x44, 0x4e, 0x9d, 0x5c, 0xf6, 0x28, 0xad, 0x5f,
	0xc3, 0x98, 0x32, 0xee, 0xca, 0xf9, 0x9e, 0x0d, 0x70, 0xd8, 0x4d, 0xf3, 0x22, 0x88, 0x29, 0x69,

	0xf0, 0x46, 0x65, 0xd8, 0xf8, 0x88, 0x1a, 0x00, 0x8e, 0x72, 0x4e, 0xaf, 0x17, 0x7b, 0x91, 0x35,
	0xb8, 0x12, 0xc2, 0xd0, 0x1a, 0x6e, 0x9b, 0x49, 0xd6, 0xbb, 0xa2, 0x5f, 0xcd, 0x42, 0xf3, 0x99,

	0x69, 0xea, 0xc8, 0x79, 0xba, 0xc3, 0x61, 0xe0, 0x79, 0x33, 0xea, 0x8e, 0xe6, 0xc2, 0x49, 0x8f,
	0x10, 0xbd, 0x3d, 0x20, 0xbc, 0x7d, 0xa2, 0x15, 0x4e, 0xd4, 0x2e, 0x72, 0x6d, 0xa4, 0xd5, 0x36,

	0x77, 0xb6, 0x99, 0x03, 0x2f, 0x19, 0xcb, 0x7f, 0xd4, 0xd9, 0xd7, 0xaf, 0x69, 0x19, 0x56, 0x86,
	0x24, 0xca, 0xad, 0x4a, 0xab, 0x51, 0x88, 0x97, 0x1e, 0x82, 0x06, 0x26, 0xf3, 0x6a, 0xf5, 0x7f,

	0xbb, 0x16, 0x97, 0x5f, 0xf7, 0xc0, 0x31, 0x59, 0x76, 0x8e, 0xa2, 0xb0, 0xd3, 0x76, 0x6f, 0x47,
	0xcb, 0xc9, 0xa7, 0x08, 0x3c, 0x83, 0xcf, 0xfb, 0x5c, 0xc4, 0x14, 0x6f, 0xb2, 0xa7, 0x2c, 0xdc,

	0xb7, 0xde, 0x32, 0xe7, 0x09, 0x1d, 0xb6, 0x70, 0x5e, 0xac, 0x0a, 0x53, 0x59, 0xf1, 0x61, 0x41,
	0x76, 0x53, 0xdd, 0x96, 0xb4, 0x86, 0x43, 0x60, 0x5a, 0x0c, 0x61, 0x94, 0x72, 0xa3, 0xcb, 0xbe,

	0x79, 0x30, 0x0f, 0x8d, 0x44, 0x57, 0xe8, 0xff, 0x85, 0x1a, 0xd3, 0x86, 0xf9, 0x21, 0x09, 0x8e,
	0x29, 0x0d, 0xd4, 0xc2, 0x46, 0x4e, 0x0e, 0xde, 0xe7, 0x8d, 0xb8, 0xdf, 0x9b, 0x19, 0xc1, 0xdb,

	0x36, 0x79, 0x26, 0xc5, 0xf0, 0xc0, 0x9f, 0x05, 0x6a, 0x20, 0x17, 0x0a, 0xec, 0x2d, 0xed, 0x8a,
	0xc9, 0xac, 0x43, 0x66, 0x3e, 0xf2, 0x18, 0x45, 0x54, 0xf3, 0x9e, 0xcd, 0xe0, 0x6f, 0xa2, 0xb0,

	0x87, 0xec, 0x0a, 0xae, 0x64, 0x3e, 0x6d, 0x04, 0x62, 0xba, 0xb1, 0x64, 0x19, 0xa8, 0x37, 0xf4,
	0x98, 0xc3, 0x14, 0x37, 0xeb, 0xc4, 0x8a, 0x69, 0x40, 0x57, 0xe1, 0x5b, 0xcd, 0x89, 0xa2, 0xb5,

	0x0f, 0x73, 0xe6, 0x02, 0x2f, 0x67, 0xda, 0xed, 0xe8, 0x71, 0x45, 0x9b, 0x1c, 0xa5, 0x07, 0xb1,
	0x82, 0xf2, 0xf3, 0x00, 0x60, 0xc8, 0xc9, 0x49, 0x1c, 0x44, 0xe9, 0xd2, 0x6d, 0xaa, 0xfd, 0xed,

	0xc0, 0x0b, 0x8f, 0x6e, 0xdc, 0xd5, 0x16, 0x4a, 0x59, 0xc1, 0x4a, 0xc8, 0xbf, 0xf1, 0xe9, 0xbf,
	0x93, 0x35, 0x07, 0x6a, 0x69, 0x82, 0xb8, 0xe0, 0x48, 0x5b, 0xeb, 0xd4, 0xab, 0xea, 0x2f, 0x94,

	0x84, 0x5d, 0x16, 0x6f, 0x2d, 0x3a, 0xa6, 0x65, 0x09, 0x57, 0x06, 0x41, 0xa7, 0x98, 0xd1, 0xd9,
	0x71, 0x3a, 0x5c, 0x64, 0xd6, 0xa2, 0xee, 0xda, 0xf8, 0xde, 0xf3, 0x31, 0x6f, 0x6e, 0x5b, 0xd1,

	0x55, 0xf4, 0x21, 0xdf, 0xe1, 0xe8, 0x9e, 0x57, 0x8d, 0xbd, 0x54, 0x2b, 0x11, 0x9f, 0x1f, 0x51,
	0x26, 0x36, 0x8f, 0x20, 0xc9, 0x5b, 0x48, 0x0b, 0x3e, 0xf1, 0x99, 0x18, 0xa7, 0x13, 0xf1, 0x73,

	0xba, 0x6e, 0x4a, 0x13, 0xf4, 0x4e, 0xfc, 0xa2, 0x8f, 0x9f, 0x25, 0x93, 0x4e, 0x71, 0x70, 0x89,
	0x7f, 0xd8, 0xcf, 0x02, 0x2b, 0x1c, 0x6a, 0x8f, 0x01, 0x3a, 0x0a, 0x60, 0xc7, 0x75, 0x84, 0xfe,

	0xc5, 0x3e, 0x08, 0x6a, 0x65, 0xc9, 0xda, 0xb5, 0x02, 0x78, 0xb6, 0x96, 0x1b, 0x17, 0xa1, 0xdb,
	0x48, 0x53, 0xa1, 0x89, 0x41, 0x56, 0xa7, 0x1e, 0x01, 0x5c, 0x7a, 0xcc, 0x71, 0x3b, 0x7f, 0xcb,

	0xdb, 0xb6, 0x39, 0x36, 0xc7, 0x54, 0xb6, 0xe9, 0x4d, 0x5d, 0x57, 0x4d, 0x69, 0xae, 0xa6, 0xe0,
	0xfb, 0xad, 0xd6, 0x06, 0x00, 0xe8, 0x7c, 0xc6, 0xbe, 0x17, 0xb3, 0xeb, 0xa1, 0x13, 0xc5, 0xe6,
};

/* Verify the calculated chunk boundaries and IDs against what the regular
 * casync tool calculates for some random data.
 */
static void random_chunking(void **state)
{
	struct chunker *c = (struct chunker*)*state;

	struct xorshift32_state rng = XORSHIFT32_INIT(RANDOM_SEED);
	size_t offset = 0;

	size_t boundary_idx = 0;
	size_t id_idx = 0;

	uint8_t buf[512];
	size_t buf_fill = 0;

	uint8_t id[CHUNK_ID_LEN];
	u_build_assert(sizeof(random_chunk_ids) % CHUNK_ID_LEN == 0);

	while (offset < RANDOM_SIZE) {
		if (buf_fill == 0) {
			xorshift32_fill(&rng, buf, sizeof(buf));
			buf_fill = sizeof(buf);
		}

		size_t ret;
		ret = chunker_scan(c, buf, buf_fill);
		if (ret == (size_t)-1) {
			offset += buf_fill;
			buf_fill = 0;

			continue;
		}

		assert_true(boundary_idx < ARRAY_SIZE(random_chunk_boundaries));

		offset += ret;
		if (random_chunk_boundaries[boundary_idx] != offset)
			fail_msg("chunk boundary mismatch at index %zu: Expected %zu, got %zu.",
			         boundary_idx, random_chunk_boundaries[boundary_idx], offset);

		boundary_idx++;

		if (id_idx < sizeof(random_chunk_ids))
		{
			chunker_get_id(c, id);
			assert_memory_equal(id, &random_chunk_ids[id_idx], CHUNK_ID_LEN);

			id_idx += CHUNK_ID_LEN;
		}

		chunker_reset(c);
		memmove(buf, &buf[ret], buf_fill-ret);
		buf_fill -= ret;
	}

	uint8_t final_chunk_id[] = {
		0x88, 0x2a, 0xb0, 0x7f, 0x13, 0xe3, 0x4f, 0x07, 0x10, 0x91, 0xf0, 0xa3, 0x54, 0xf7, 0x16, 0x4a,
		0xb8, 0x34, 0xaa, 0x50, 0x0e, 0xe1, 0x2b, 0x2f, 0x2f, 0xb1, 0x83, 0x93, 0x8e, 0xf5, 0x3d, 0xef
	};

	chunker_get_id(c, id);
	assert_memory_equal(id, final_chunk_id, CHUNK_ID_LEN);

	assert_int_equal(boundary_idx, ARRAY_SIZE(random_chunk_boundaries));
}

/* After encountering a chunk boundary, we should not consume any more data until we are reset
 */
static void stuck_after_chunk(void **state)
{
	struct chunker *c = (struct chunker*)*state;

	uint8_t buf[] = "Hello, world!";
	size_t ret;

	do {
		ret = chunker_scan(c, buf, sizeof(buf));
	} while (ret == (size_t)-1);

	assert_int_equal(chunker_scan(c, buf, sizeof(buf)), 0);

	chunker_reset(c);
	assert_int_not_equal(chunker_scan(c, buf, sizeof(buf)), 0);
}

static void discriminator(void **state)
{
	struct chunker *c = (struct chunker*)*state;

	/* We have a build-time check for the discriminator calculation, but
	 * let's also do this at runtime to make sure this also works on the
	 * target arch, should the tests be run there.
	 */

	assert_int_equal(c->discriminator, 0xc17f);
}

/* Check that we don't mess anything up if we don't fill up the window on the
 * first call after a reset.
 */
static void partial_window_feed(void **state)
{
	struct chunker *c = (struct chunker*)*state;

	struct xorshift32_state rng = XORSHIFT32_INIT(RANDOM_SEED);
	uint8_t buf[128];
	size_t offset = 0;
	xorshift32_fill(&rng, buf, sizeof(buf));

	const uint32_t good_hash = 0xec7de6d0;

	u_build_assert(sizeof(buf) > CHUNKER_WINDOW_SIZE);

#define RESET() do { chunker_reset(c); offset = 0; } while (0)
#define FEED(amount) do { assert_int_equal(chunker_scan(c, &buf[offset], amount), (size_t)-1); offset += amount;} while (0)
#define FEED_REST() FEED(sizeof(buf) - offset)
#define CHECK() assert_int_equal(c->h, good_hash)

	RESET();
	FEED_REST();
	CHECK();

	RESET();
	FEED(0); FEED_REST(); FEED(0);
	CHECK();

	RESET();
	FEED(1); FEED_REST();
	CHECK();

	RESET();
	FEED(CHUNKER_WINDOW_SIZE - 1); FEED_REST();
	CHECK();

	RESET();
	FEED(CHUNKER_WINDOW_SIZE - 1); FEED(1); FEED_REST();
	CHECK();

	RESET();
	FEED(CHUNKER_WINDOW_SIZE - 1); FEED(1); FEED(1); FEED_REST();
	CHECK();

	RESET();
	FEED(CHUNKER_WINDOW_SIZE); FEED(1); FEED_REST();
	CHECK();

	RESET();
	FEED(CHUNKER_WINDOW_SIZE); FEED_REST();
	CHECK();
#undef RESET
#undef FEED
#undef FEED_REST
#undef CHECK
}

int main(void)
{
	const struct CMUnitTest tests[] = {
		cmocka_unit_test_setup_teardown(random_chunking, create_chunker, destroy_chunker),
		cmocka_unit_test_setup_teardown(stuck_after_chunk, create_chunker, destroy_chunker),
		cmocka_unit_test_setup_teardown(discriminator, create_chunker, destroy_chunker),
		cmocka_unit_test_setup_teardown(partial_window_feed, create_chunker, destroy_chunker),
	};

	u_log_init();

	return cmocka_run_group_tests_name("chunker", tests, NULL, NULL);
}
